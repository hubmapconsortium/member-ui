{% extends "layouts/main.html" %}
{% block content %}

<h1>HuBMAP User Registration</h1>

<script type="text/javascript">
    // Enable the submit button only after recaptcha is checked
    // this needs to be defined in the global scope - Zhou
    function recaptchaCallback() {
        $('#submitBtn').removeAttr('disabled');
    };
    $(function() {
        var biography_length_limit = 50000;
        
        // Hide these by default
        $(".oth-cmpnt").hide();
        $(".component_detail_card").hide();
        $(".oth-org").hide();
        $(".oth-role").hide();
        $(".google-email").hide();
        $(".slack-username").hide();
        $(".github-username").hide();
        $("div.pm-name").hide();
        $("div.pm-email").hide();
        $(".main-error-message").hide();

        $("#id_component").change(function() {
            let id = $(this).children("option:selected").val();
            $("[id^='cmpnt_']").hide();
            $("div[data-name='" + id + "']").show();
            if(id==='Other'){ // other selected
                $(".oth-cmpnt").show();
            } else {
                $("#id_other_component").val('');
                $(".oth-cmpnt").hide();
            }
        });
        $("#id_organization").change(function() {
            let id = $(this).children("option:selected").val();
            if(id==='Other'){ // other selected
                $(".oth-org").show();
            } else {
                $("#id_other_organization").val('');
                $(".oth-org").hide();
            }
        });
        $("#id_role").change(function() {
            let id = $(this).children("option:selected").val();
            if(id==='Other'){ // other selected
                $(".oth-role").show();
            } else {
                $("#id_other_role").val('');
                $(".oth-role").hide();
            }
        });
        $("#id_access_requests_3").change(function() {
            if (!this.checked){
                $("#id_google_email").val('');
            }
            $(".google-email").toggle(this.checked);
        });
        $("#id_access_requests_4").change(function() {
            if (!this.checked){
                $("#id_github_username").val('');
            }
            $(".github-username").toggle(this.checked);
        });
        $("#id_access_requests_5").change(function() {
            if (!this.checked){
                $("#id_slack_username").val('');
            }
            $(".slack-username").toggle(this.checked);
        });
        let id = $("#id_component").children("option:selected").val();
        $("[id^='cmpnt_']").hide();
        $("#cmpnt_" + id).show();
        if(id==='Other'){ // other selected
            $(".oth-cmpnt").show()
        } else {
            $(".oth-cmpnt").hide()
        }
        id = $('#id_organization').children("option:selected").val();
        if(id==='Other'){ // other selected
            $(".oth-org").show();
        } else {
            $(".oth-org").hide();
        }
        id = $("#id_role").children("option:selected").val();
        if(id==='Other'){ // other selected
            $(".oth-role").show();
        } else {
            $(".oth-role").hide();
        }
        if ($("#id_access_requests_0").is(':checked')){
            $("#id_access_requests_0").prop('disabled', true);
        }
        if ($("#id_access_requests_1").is(':checked')){
            $("#id_access_requests_1").prop('disabled', true);
        }
        if ($("#id_access_requests_2").is(':checked')){
            $("#id_access_requests_2").prop('disabled', true);
        }
        if ($("#id_access_requests_3").is(':checked')){
            $("#id_access_requests_3").prop('disabled', true);
            $(".google-email").show();
            $("#id_google_email").prop('disabled', true);
        }
        if ($("#id_access_requests_4").is(':checked')){
            $("#id_access_requests_4").prop('disabled', true);
            $(".github-username").show();
            $("#id_github_username").prop('disabled', true);
        }
        if ($("#id_access_requests_5").is(':checked')){
            $("#id_access_requests_5").prop('disabled', true);
            $(".slack-username").show();
            $("#id_slack_username").prop('disabled', true);
        }
        if ($("#id_access_requests_6").is(':checked')){
            $("#id_access_requests_6").prop('disabled', true);
        }
        if($(":radio[id^='id_pm_0']").is(':checked')){
            $("div.pm-name").show();
            $("div.pm-email").show();
        }
        $('#id_photo_url').change(function() {
            $('#id_photo').val('');
        });
        $('#id_photo').change(function() {
            $('#id_photo_url').val('');
        })
        function readURL(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#profile_picture').attr('src', e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        function delay(callback, ms) {
            var timer = 0;
            return function() {
                var context = this, args = arguments;
                clearTimeout(timer);
                timer = setTimeout(function () {
                callback.apply(context, args);
                }, ms || 0);
            };
        }
        $("#id_photo").change(function() {
            readURL(this);
        });
        $("#id_photo_url").keyup(delay(function(e) {
            $('#profile_picture').attr('src', "{{ url_for('static', filename = 'images/default_profile.png') }}");
            $('#profile_picture').attr('src', e.target.value);
        }, 500));
        $(":radio[id^='id_pm_']").change(function() {
            if($(this).val() === 'Yes'){
                $("div.pm-name").show();
                $("div.pm-email").show();
            } else {
                $("#id_pm_name").val('');
                $("div.pm-name").hide();
                $("#id_pm_email").val('');
                $("div.pm-email").hide();
            }
        });
        $("#id_expertise").keyup(function() {
            if($(this).val().length > biography_length_limit) {
                $("#id_expertise").nextAll().remove();
                $("#id_expertise").addClass('is-invalid');
                $("#id_expertise").after("<div class='invalid-feedback'>Biography is too long. Please limit the length to " + biography_length_limit + " characters.</div>");
            } else {
                $("#id_expertise").removeClass('is-invalid');
                $("#id_expertise").nextAll().remove();
            }
        })
        
        $("#registration-form").submit(function(e){
            e.preventDefault();
            var form = this;
            valid = true;
            $(form).find('.invalid-feedback').remove();
            $(form).find('.is-invalid').removeClass('is-invalid');
            if($.trim($("#id_email").val()) === ''){
                valid = false;
                $("#id_email").addClass('is-invalid');
                $("#id_email").after("<div class='invalid-feedback'>Email is required.</div>");
            }
            if($.trim($("#id_phone").val()) === ''){
                valid = false;
                $("#id_phone").addClass('is-invalid');
                $("#id_phone").after("<div class='invalid-feedback'>Phone is required.</div>");
            }
            if($.trim($("#id_first_name").val()) === ''){
                valid = false;
                $("#id_first_name").addClass('is-invalid');
                $("#id_first_name").after("<div class='invalid-feedback'>First Name is required.</div>");
            }
            if($.trim($("#id_last_name").val()) === ''){
                valid = false;
                $("#id_last_name").addClass('is-invalid');
                $("#id_last_name").after("<div class='invalid-feedback'>Last Name is required.</div>");
            }
            if($.trim($("#id_component").val()) === '----'){
                valid = false;
                $("#id_component").addClass('is-invalid');
                $("#id_component").after("<div class='invalid-feedback'>Adward/Component is required.</div>");
            }
            if($.trim($("#id_component").val()) === 'Other' && $.trim($("#id_other_component").val()) === ''){
                valid = false;
                $("#id_other_component").addClass('is-invalid');
                $("#id_other_component").after("<div class='invalid-feedback'>Award/Component is required.</div>");
            }
            if($.trim($("#id_organization").val()) === '----'){
                valid = false;
                $("#id_organization").addClass('is-invalid');
                $("#id_organization").after("<div class='invalid-feedback'>Organization is required.</div>");
            }
            if($.trim($("#id_organization").val()) === 'Other' && $.trim($("#id_other_organization").val()) === ''){
                valid = false;
                $("#id_other_organization").addClass('is-invalid');
                $("#id_other_organization").after("<div class='invalid-feedback'>Organization is required.</div>");
            }
            if($.trim($("#id_role").val()) === '----'){
                valid = false;
                $("#id_role").addClass('is-invalid');
                $("#id_role").after("<div class='invalid-feedback'>Role is required.</div>");
            }
            if($.trim($("#id_role").val()) === 'Other' && $.trim($("#id_other_role").val()) === ''){
                valid = false;
                $("#id_other_role").addClass('is-invalid');
                $("#id_other_role").after("<div class='invalid-feedback'>Role is required.</div>");
            }
            if($("#id_access_requests_3").is(':checked') && $.trim($("#id_google_email").val()) === ''){
                valid = false;
                $("#id_google_email").addClass('is-invalid');
                $("#id_google_email").after("<div class='invalid-feedback'>Google account is required.</div>");
            }
            if($("#id_access_requests_4").is(':checked') && $.trim($("#id_github_username").val()) === ''){
                valid = false;
                $("#id_github_username").addClass('is-invalid');
                $("#id_github_username").after("<div class='invalid-feedback'>GitHub username is required.</div>");
            }
            if($("#id_access_requests_5").is(':checked') && $.trim($("#id_slack_username").val()) === ''){
                valid = false;
                $("#id_slack_username").addClass('is-invalid');
                $("#id_slack_username").after("<div class='invalid-feedback'>Slack username is required.</div>");
            }
            if($("#id_expertise").val().length > biography_length_limit){
                valid = false;
                $("#id_expertise").addClass('is-invalid');
                $("#id_expertise").after("<div class='invalid-feedback'>Biography is too long. Please limit the length to " + biography_length_limit + " characters.</div>");
            }
            if($("#id_pm_0").is(':checked') && $.trim($("#id_pm_name").val()) === ''){
                valid = false;
                $("#id_pm_name").addClass('is-invalid');
                $("#id_pm_name").after("<div class='invalid-feedback'>Project Manager's name is required.</div>");
            }
            if($("#id_pm_0").is(':checked') && $.trim($("#id_pm_email").val()) === ''){
                valid = false;
                $("#id_pm_email").addClass('is-invalid');
                $("#id_pm_email").after("<div class='invalid-feedback'>Project Manager's email is required.</div>");
            }
            if(valid){
                form.submit();
            } else {
                $(".main-error-message").show();
            }
        });
        $('[data-toggle="tooltip"]').tooltip()
    });
</script>

<div class="row">
    <div class="col-sm-12">
        <form id="registration-form" method="POST" action="/register" enctype="multipart/form-data">
			<input type="hidden" name="csrf_token" value="{{ data.csrf_token }}">

            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="first-name">First Name <span class="text-danger">*</span></label>
                        
                        <input type="text" name="first_name" value="{{ data.first_name }}" class="form-control" maxlength="100" id="id_first_name">
                        <div class="invalid-feedback">
                            
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="last-name">Last Name <span class="text-danger">*</span></label>
                        
                        <input type="text" name="last_name" value="{{ data.last_name }}" class="form-control" maxlength="100" id="id_last_name">
                        <div class="invalid-feedback">
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="email">Email address <span class="text-danger">*</span></label>
                        
                        <input type="email" name="email" value="{{ data.email }}" class="form-control" maxlength="100" id="id_email">
                        <div class="invalid-feedback">
                            
                        </div>
                    </div>
                </div>
                <div class="col">
                    <div class="form-group">
                        <label for="phone">Phone number <span class="text-danger">*</span></label>
                        <input type="text" name="phone" class="form-control" maxlength="13" id="id_phone">
                        <div class="invalid-feedback">
                            
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="form-group">
                        <label for="component">Award/component <span class="text-danger">*</span></label>
                        {% include 'component_selection.html' %}
                                    <div class="invalid-feedback">
                                        
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group oth-cmpnt">
                                            <label for="other_component">Component: What component are you with?</label>
                                            <input type="text" name="other_component" class="form-control" maxlength="100" id="id_other_component">
                                            <div class="invalid-feedback">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="organization">Organization <span class="text-danger">*</span></label>
                                    {% include 'organization_selection.html' %}

                                    <div class="invalid-feedback">
                                        
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group oth-org">
                                            <label for="other_organization">Organization: What organization are you with?</label>
                                            <input type="text" name="other_organization" class="form-control" maxlength="100" id="id_other_organization">
                                            <div class="invalid-feedback">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            {% include 'component_cards.html' %}
                        </div>

                        <div class="form-group">
                            <label for="role">Role in HuBMAP <span class="text-danger">*</span></label>
                            {% include 'role_selection.html' %}

                            <div class="invalid-feedback">
                                
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-12">
                                <div class="form-group oth-role">
                                    <label for="other_role">Role: What is your role in HuBMAP?</label>
                                    <input type="text" name="other_role" class="form-control" maxlength="100" id="id_other_role">
                                    <div class="invalid-feedback">
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        <label for="file">Profile Picture</label>
                        <div class="row">
                            <div class="col-xs-12 col-sm-3">
                                <img src="{{ url_for('static', filename='images/default_profile.png') }}" alt="" class="img-thumbnail" id="profile_picture">
                            </div>
                            <div class="col-xs-12 col-sm-9">
                                <ul class="nav nav-tabs" id="myTab" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="file-tab" data-toggle="tab" href="#file" role="tab" aria-controls="file" aria-selected="true">Upload New Image</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" id="url-tab" data-toggle="tab" href="#url" role="tab" aria-controls="url" aria-selected="false">Pull Image From Exsitng URL</a>
                                    </li>
                                </ul>
                                <div class="tab-content" id="myTabContent">
                                    <div class="tab-pane fade show active" id="file" role="tabpanel" aria-labelledby="file-tab">
                                        <div class="form-photo">
                                            <input type="file" name="photo" class="form-control" accept="image/*" id="id_photo">
                                            <div class="invalid-feedback">
                                                
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="url" role="tabpanel" aria-labelledby="url-tab">
                                        <div class="form-photo-url">
                                            <input type="url" name="photo_url" class="form-control" placeholder="http://example.com" id="id_photo_url">
                                            <div class="invalid-feedback">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="group">What HuBMAP working groups are you a member of?</label>
                            <ul id="id_working_group">
    <li><label for="id_working_group_0"><input type="checkbox" name="working_group" value="Communications &amp; Engagement" id="id_working_group_0">
 Communications &amp; Engagement</label>

</li>
    <li><label for="id_working_group_1"><input type="checkbox" name="working_group" value="Data Science" id="id_working_group_1">
 Data Science</label>

</li>
    <li><label for="id_working_group_2"><input type="checkbox" name="working_group" value="Policies" id="id_working_group_2">
 Policies</label>

</li>
    <li><label for="id_working_group_3"><input type="checkbox" name="working_group" value="Tissue, Technology &amp; Data Collection" id="id_working_group_3">
 Tissue, Technology &amp; Data Collection</label>

</li>
    <li><label for="id_working_group_4"><input type="checkbox" name="working_group" value="Tools &amp; Models" id="id_working_group_4">
 Tools &amp; Models</label>

</li>
</ul>
                            <div class="invalid-feedback">
                                
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-12 col-sm-6" style="min-height: 20em;">
                                <div class="form-group">
                                    <label for="access-requests">Which HuBMAP resources will you need to access?</label>
                                    <ul id="id_access_requests">
    <li><label for="id_access_requests_0"><input type="checkbox" name="access_requests" value="Collaboration Portal" id="id_access_requests_0" checked>
 Collaboration Portal</label>

</li>
    <li><label for="id_access_requests_1"><input type="checkbox" name="access_requests" value="Sample Data Portal" id="id_access_requests_1">
 Sample Data Portal</label>

</li>
    <li><label for="id_access_requests_2"><input type="checkbox" name="access_requests" value="HuBMAP Data Portal" id="id_access_requests_2">
 HuBMAP Data Portal</label>

</li>
    <li><label for="id_access_requests_3"><input type="checkbox" name="access_requests" value="HuBMAP Google Drive Share" id="id_access_requests_3">
 HuBMAP Google Drive Share</label>

</li>
    <li><label for="id_access_requests_4"><input type="checkbox" name="access_requests" value="HuBMAP GitHub Repository" id="id_access_requests_4">
 HuBMAP GitHub Repository</label>

</li>
    <li><label for="id_access_requests_5"><input type="checkbox" name="access_requests" value="HuBMAP Slack Workspace" id="id_access_requests_5">
 HuBMAP Slack Worksapce</label>

</li>
    <li><label for="id_access_requests_6"><input type="checkbox" name="access_requests" value="Edit My Component&#39;s Project Page" id="id_access_requests_6">
 Edit My Component&#39;s Project Page</label>

</li>
</ul>
                                    <div class="invalid-feedback">
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-6">
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group form-group-sm google-email">
                                            <label for="google_email">Your Google account email address: <span class="text-danger">*</span> <button type="button" class="btn btn-link" data-toggle="tooltip" data-placement="right" data-html="true" title="Please enter the email address that you use to log into Google.  HuBMAP specific Google documents will be shared with this account.">what is this?</button></label>
                                            <input type="email" name="google_email" class="form-control" maxlength="100" id="id_google_email">
                                            <div class="invalid-feedback">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group form-group-sm github-username">
                                            <label for="github_username">Your GitHub username: <span class="text-danger">*</span></label>
                                            <input type="text" name="github_username" class="form-control" maxlength="100" id="id_github_username">
                                            <div class="invalid-feedback">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12">
                                        <div class="form-group form-group-sm slack-username">
                                            <label for="slack_username">Your email address for the slack invitation: <span class="text-danger">*</span></label>
                                            <input type="text" name="slack_username" class="form-control" maxlength="100" id="id_slack_username">
                                            <div class="invalid-feedback">
                                                
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group">
		                            <label for="orcid">What is your ORCID ID?</label>
		                            <input type="text" name="orcid" class="form-control" maxlength="100" id="id_orcid">
		                            <div class="invalid-feedback">
		                                
		                            </div>
		                        </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group">
		                            <label for="website">URL of a personal profile page to share with the consortium.</label>
		                            <input type="url" name="website" class="form-control" maxlength="500" id="id_website">
		                            <div class="invalid-feedback">
		                                
		                            </div>
		                        </div>
                            </div>
                        </div>

                        
                        <div class="form-group">
                            <label for="expertise">Biography: Please provide any biographical information that you'd like to share. This information may be shared publicly.</label>
                            <textarea name="expertise" cols="40" rows="6" class="form-control" id="id_expertise">
</textarea>
                            <div class="invalid-feedback">
                                
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="pm">Is there a project manager who should be copied on all communications to you?</label>
                            <ul id="id_pm">
    <li><label for="id_pm_0"><input type="radio" name="pm" value="Yes" id="id_pm_0">
 Yes</label>

</li>
    <li><label for="id_pm_1"><input type="radio" name="pm" value="No" id="id_pm_1" checked>
 No</label>

</li>
</ul>
                            <div class="invalid-feedback">
                                
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-6">
                                <div class="form-group pm-name">
                                    <label for="pm_name">Project Manager's Name</label>
                                    <input type="text" name="pm_name" class="form-control" maxlength="100" id="id_pm_name">
                                    <div class="invalid-feedback">
                                        
                                    </div>
                                </div>
                            </div>

                            <div class="col-sm-6">
                                <div class="form-group pm-email">
                                    <label for="pm_email">Project Manager's Email</label>
                                    <input type="email" name="pm_email" class="form-control" maxlength="100" id="id_pm_email">
                                    <div class="invalid-feedback">
                                        
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-danger main-error-message">
                            There are errors, please correct the fields above.
                        </div>

            <!-- reCAPTCHA v2 checkbox -->
            <div class="row">
                <div class="col-sm-12">
                    <div class="form-group g-recaptcha" data-callback="recaptchaCallback" data-sitekey="{{ data.recaptcha_site_key }}"></div>
                </div>
            </div>


            <button type="submit" id="submitBtn" class="btn btn-primary" >Submit</button>
        </form>

        <script src="https://www.google.com/recaptcha/api.js" async defer></script>

    </div>
</div>


{% endblock %}
